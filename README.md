# Анализ уязвимостей смарт-контрактов

## Обзор

Этот репозиторий содержит упрощенные примеры и демонстрации нескольких важных уязвимостей смарт-контрактов, которые были использованы в DeFi протоколах:

1. **Уязвимости токенов** - Демонстрирует переполнение/недополнение целых чисел и другие проблемы в реализации токенов.
2. **Уязвимости аукционов** - Показывает проблемы с манипуляцией ставками и ошибки в логике аукционов.
3. **Уязвимости кредитных протоколов** - Демонстрирует ошибки в расчете процентов и управлении займами.
4. **Эксплойт непроверенного контракта** - Показывает, как непроверенные контракты с недостаточным контролем доступа могут быть использованы.

## Уязвимость 1: Токен-контракты

### Описание

Уязвимости в токен-контрактах часто связаны с арифметическими ошибками, такими как переполнение и недополнение целых чисел, а также с недостаточной проверкой условий.

### Как это работает

1. Атакующий использует функции с неправильной арифметикой для создания токенов из воздуха
2. Ошибки в функциях перевода позволяют обходить проверки баланса
3. Массовые переводы могут вызывать переполнение счетчиков

### Ключевые уязвимые функции

- `VulnerableToken.vulnerableBatchTransfer()` - Переполнение при умножении
- `VulnerableToken.transfer()` - Недостаточная проверка баланса
- `VulnerableToken.vulnerableMint()` - Переполнение при создании токенов

## Уязвимость 2: Аукционные контракты

### Описание

Аукционные контракты могут содержать уязвимости в логике определения победителя, манипуляции ставками и обработке возвратов средств.

### Как это работает

1. Атакующий может манипулировать ставками без внесения средств
2. Ошибки в логике возвратов позволяют извлекать средства
3. Проблемы с проверкой времени окончания аукциона

### Ключевые уязвимые функции

- `VulnerableAuction.maliciousBid()` - Позволяет установить произвольную ставку
- `VulnerableAuction.withdraw()` - Неправильная обработка возвратов
- `VulnerableAuction.endAuction()` - Отсутствие проверок при завершении

## Уязвимость 3: Кредитные протоколы

### Описание

Кредитные протоколы могут содержать ошибки в расчете процентов, управлении залогом и проверке условий займов.

### Как это работает

1. Атакующий манипулирует расчетом процентов
2. Ошибки в проверке залога позволяют брать займы без обеспечения
3. Проблемы с обновлением состояния счетов

### Ключевые уязвимые функции

- `VulnerableLending.forceUpdateInterest()` - Позволяет обновлять чужие счета
- `VulnerableLending.getAvailableToBorrow()` - Некорректный расчет доступных средств
- `VulnerableLending.repay()` - Отсутствие проверки на переплату

## Уязвимость 4: Непроверенный контракт

### Описание

Непроверенные контракты в блокчейне не имеют прозрачности, что затрудняет оценку их безопасности. Этот пример показывает, как недостаточный контроль доступа в непроверенных контрактах может быть использован.

### Как это работает

1. Атакующий вызывает функцию в непроверенном контракте
2. Из-за отсутствия контроля доступа атакующий может делать произвольные вызовы
3. Атакующий использует это для взаимодействия с другими протоколами

### Ключевые уязвимые функции

- `Unverified.callWithSelector()` - Нет контроля доступа

## Структура проекта

```
Smart_Contract_Vulnerability_Analysis/
├── README.md              # Этот файл
├── foundry.toml           # Конфигурация Foundry
├── lib/                   # Зависимости (forge-std)
├── src/                   # Примеры уязвимых контрактов
│   ├── VulnerableToken.sol         # Уязвимый токен-контракт
│   ├── VulnerableAuction.sol       # Уязвимый аукцион
│   ├── VulnerableLending.sol       # Уязвимый кредитный протокол
│   └── Unverified.sol              # Пример непроверенного контракта
└── test/                  # Демонстрации эксплойтов
    └── Vulnerabilities.t.sol       # Тесты для всех уязвимостей (включая непроверенный контракт)
```

## Описание файлов

### src/VulnerableToken.sol
Токен-контракт с различными арифметическими уязвимостями. Содержит функции для перевода токенов, одобрения расходования и массовых переводов. Уязвимости включают переполнение при умножении в `vulnerableBatchTransfer`, недостаточную проверку баланса в `transfer` и проблемы с учетом общего количества токенов.

### src/VulnerableAuction.sol
Аукционный контракт с уязвимостями в логике ставок и завершения аукциона. Позволяет устанавливать произвольные ставки без внесения средств через `maliciousBid`, имеет проблемы с обработкой возвратов в `withdraw` и недостаточные проверки в `endAuction`.

### src/VulnerableLending.sol
Кредитный протокол с ошибками в расчете процентов и управлении займами. Содержит функцию `forceUpdateInterest`, которая позволяет обновлять проценты по чужим счетам, некорректный расчет доступных средств в `getAvailableToBorrow` и проблемы с проверкой условий в `repay`.

### src/Unverified.sol
Пример непроверенного контракта с недостаточным контролем доступа. Функция `callWithSelector` позволяет делать произвольные вызовы без проверки вызывающей стороны, что может быть использовано для взаимодействия с другими протоколами.

### test/Vulnerabilities.t.sol
Комплексный тест, демонстрирующий все основные уязвимости. Содержит тесты для токенов (`VulnerableTokenTest`), аукционов (`VulnerableAuctionTest`), кредитных протоколов (`VulnerableLendingTest`) и непроверенного контракта (`UnverifiedTest`). Каждый тест показывает конкретную уязвимость и как она может быть использована. Контракт атакующего (`UnverifiedAttacker`) демонстрирует эксплойт непроверенного контракта.

## Требования

- [Foundry](https://getfoundry.sh/)

## Установка

1. Установите Foundry:
   ```bash
   curl -L https://foundry.paradigm.xyz | bash
   # Перезапустите терминал или выполните:
   # source ~/.bashrc (или source ~/.zshrc)
   foundryup
   ```

2. Клонируйте этот репозиторий:
   ```bash
   git clone <repository-url>
   cd Smart_Contract_Vulnerability_Analysis
   ```

## Запуск эксплойтов

### Запуск тестов для токенов

```bash
# Запуск с подробным логированием
forge test --match-contract VulnerableTokenTest -vvv
```

### Запуск тестов для аукционов

```bash
# Запуск с подробным логированием
forge test --match-contract VulnerableAuctionTest -vvv
```

### Запуск тестов для кредитных протоколов

```bash
# Запуск с подробным логированием
forge test --match-contract VulnerableLendingTest -vvv
```

### Запуск тестов для непроверенного контракта

```bash
# Запуск с подробным логированием
forge test --match-contract UnverifiedTest -vvv
```

### Запуск всех тестов

```bash
# Запуск всех тестов
forge test

# Запуск всех тестов с подробным логированием
forge test -vvv
```

## Ключевые уроки

### Для уязвимостей токенов:
1. Всегда используйте проверенные библиотеки токенов (например, OpenZeppelin)
2. Проверяйте арифметические операции на переполнение/недополнение
3. Всегда проверяйте балансы перед списанием средств
4. Используйте SafeMath или встроенную защиту Solidity 0.8+

### Для уязвимостей аукционов:
1. Всегда проверяйте внесение средств перед обновлением состояния
2. Используйте проверенные паттерны аукционов
3. Проверяйте время начала и окончания аукциона
4. Обрабатывайте возвраты средств с проверкой результата

### Для уязвимостей кредитных протоколов:
1. Всегда проверяйте залог перед выдачей займа
2. Используйте точные библиотеки для расчета процентов
3. Защищайте функции обновления состояния от несанкционированного доступа
4. Проверяйте все входные параметры

### Для непроверенных контрактов:
1. Всегда верифицируйте контракты на блокчейн эксплорерах
2. Аудируйте непроверенные контракты перед взаимодействием с ними
3. Реализуйте строгий контроль доступа на всех внешних функциях
4. Используйте хорошо проверенные библиотеки и контракты

## Результаты анализа

После запуска эксплойтов вы увидите:
- Демонстрацию арифметических уязвимостей
- Примеры манипуляции состоянием контрактов
- Логи, показывающие поток атаки
- Способы обхода проверок безопасности

Это помогает понять, как работают эти уязвимости и как их предотвратить.